<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FilesLock - ถอดรหัสไฟล์</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
    h1 { color: #333; font-size: 24px; margin-bottom: 20px; }
    input[type="file"], input[type="password"] { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    button, .nav-button { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin: 10px; text-decoration: none; display: inline-block; }
    button:hover, .nav-button:hover { background-color: #45a049; }
    .error { color: red; margin-top: 10px; display: none; }
    .success { color: green; margin-top: 10px; display: none; }
    @media (max-width: 600px) { .container { padding: 15px; } h1 { font-size: 20px; } button, .nav-button { width: 100%; box-sizing: border-box; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>ถอดรหัสไฟล์</h1>
    <input type="file" id="decrypt-file-input" accept=".locked">
    <input type="password" id="decrypt-password-input" placeholder="กรอกรหัสผ่าน">
    <button onclick="decryptFile()">ถอดรหัส</button>
    <a href="index.html" class="nav-button">กลับสู่หน้าหลัก</a>
    <p id="decrypt-error" class="error"></p>
    <p id="decrypt-success" class="success"></p>
  </div>

  <script>
    function showMessage(elementId, message, isError = true) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.style.display = 'block';
      setTimeout(() => { element.style.display = 'none'; }, 5000);
    }

    async function decryptFile() {
      const fileInput = document.getElementById('decrypt-file-input');
      const passwordInput = document.getElementById('decrypt-password-input');
      const file = fileInput.files[0];
      const password = passwordInput.value.trim();

      if (!file || !password) {
        showMessage('decrypt-error', 'กรุณาเลือกไฟล์และกรอกรหัสผ่าน');
        return;
      }

      try {
        const reader = new FileReader();
        reader.onload = function(e) {
          const encryptedData = e.target.result;
          const textDecoder = new TextDecoder();
          const encryptedText = textDecoder.decode(encryptedData);
          
          try {
            // ถอดรหัส AES-256 ได้ Base64
            const decrypted = CryptoJS.AES.decrypt(encryptedText, password);
            const base64Data = decrypted.toString(CryptoJS.enc.Utf8);
            
            if (!base64Data) {
              throw new Error('รหัสผ่านไม่ถูกต้อง');
            }
            
            // แปลง Base64 กลับเป็นไบนารี
            const binaryData = atob(base64Data);
            const byteArray = new Uint8Array(binaryData.length);
            for (let i = 0; i < binaryData.length; i++) {
              byteArray[i] = binaryData.charCodeAt(i);
            }
            
            const blob = new Blob([byteArray], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name.replace('.locked', '');
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('decrypt-success', 'ถอดรหัสสำเร็จ!', false);
            fileInput.value = '';
            passwordInput.value = '';
          } catch (error) {
            showMessage('decrypt-error', 'ถอดรหัสล้มเหลว: รหัสผ่านไม่ถูกต้อง');
          }
        };
        reader.readAsArrayBuffer(file);
      } catch (error) {
        showMessage('decrypt-error', 'เกิดข้อผิดพลาดในการถอดรหัส: ' + error.message);
      }
    }
  </script>
</body>
</html>